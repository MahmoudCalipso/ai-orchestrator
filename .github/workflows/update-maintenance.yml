name: Update & Maintenance

on:
  schedule:
    # Run weekly on Monday at 2 AM UTC
    - cron: '0 2 * * 1'
  workflow_dispatch:

jobs:
  update-dependencies:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Update Python dependencies
        run: |
          pip install --upgrade pip pip-tools
          pip-compile --upgrade requirements.in -o requirements.txt || true
      
      - name: Update language registries
        run: |
          python -c "
          import asyncio
          from platform.registry import LanguageRegistry
          
          async def update_registries():
              registry = LanguageRegistry()
              updated = await registry.update_all_registries()
              print(f'Updated {len(updated)} registries')
              for lang, version in updated.items():
                  print(f'{lang}: {version}')
          
          asyncio.run(update_registries())
          "
      
      - name: Security scan
        run: |
          pip install safety bandit
          safety check --json || true
          bandit -r . -f json -o bandit-report.json || true
      
      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'chore: update dependencies and registries'
          title: 'ðŸ”„ Weekly Dependency Updates'
          body: |
            ## Automated Dependency Updates
            
            This PR contains automated updates for:
            - Python dependencies
            - Language/framework registries
            - Security patches
            
            ### Security Scan Results
            - Safety check completed
            - Bandit security scan completed
            
            Please review and merge if all checks pass.
          branch: automated-updates
          delete-branch: true
      
      - name: Upload security reports
        uses: actions/upload-artifact@v4
        with:
          name: security-reports
          path: |
            bandit-report.json

  cleanup-storage:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          pip install -r requirements.txt
      
      - name: Run storage cleanup
        run: |
          python -c "
          import asyncio
          from core.storage import StorageManager
          
          async def cleanup():
              storage = StorageManager()
              
              # Archive old projects
              archived = await storage.archive_old_projects(days=90)
              print(f'Archived {archived} projects')
              
              # Clean cache
              await storage.clean_cache()
              print('Cache cleaned')
              
              # Get storage stats
              stats = await storage.get_storage_stats()
              print(f'Total projects: {stats[\"total_projects\"]}')
              print(f'Total size: {stats[\"total_size_gb\"]} GB')
          
          asyncio.run(cleanup())
          "
