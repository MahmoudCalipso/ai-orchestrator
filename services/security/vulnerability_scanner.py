"""
Security Vulnerability Scanner
"""
import logging
import subprocess
import json
from typing import Dict, Any, List

logger = logging.getLogger(__name__)

class VulnerabilityScanner:
    """Scans code and dependencies for security issues"""
    
    async def scan_code(self, project_path: str, language: str) -> Dict[str, Any]:
        """Run static application security testing (SAST)"""
        results = {"issues": [], "summary": {}}
        
        if language.lower() == "python":
            results = await self._scan_python_bandit(project_path)
            
        return results

    async def scan_dependencies(self, project_path: str, language: str) -> Dict[str, Any]:
        """Run software composition analysis (SCA)"""
        results = {"vulnerabilities": [], "summary": {}}
        
        if language.lower() == "python":
            results = await self._scan_python_safety(project_path)
            
        return results

    async def _scan_python_bandit(self, path: str) -> Dict[str, Any]:
        """Run bandit on python code"""
        try:
            cmd = ["bandit", "-r", path, "-f", "json"]
            result = subprocess.run(cmd, capture_output=True, text=True)
            
            # Bandit returns non-zero exit code if issues found, so don't check=True
            if result.stdout.strip():
                try:
                    return json.loads(result.stdout)
                except json.JSONDecodeError:
                    return {"error": "Failed to parse bandit output", "raw": result.stdout}
            return {"issues": []}
        except FileNotFoundError:
            return {"error": "Bandit tool not installed"}

    async def _scan_python_safety(self, path: str) -> Dict[str, Any]:
        """Run safety on requirements.txt"""
        try:
            # Assuming requirements.txt exists
            cmd = ["safety", "check", "-r", f"{path}/requirements.txt", "--json"]
            result = subprocess.run(cmd, capture_output=True, text=True)
            
            if result.stdout.strip():
                try:
                    return json.loads(result.stdout)
                except json.JSONDecodeError:
                    # Safety output format varies by version
                    return {"raw": result.stdout}
            return {"vulnerabilities": []}
        except FileNotFoundError:
            return {"error": "Safety tool not installed"}
