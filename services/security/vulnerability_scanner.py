"""
Security Vulnerability Scanner
"""
import logging
import subprocess
import json
from typing import Dict, Any

logger = logging.getLogger(__name__)

class VulnerabilityScanner:
    """Scans code for issues and provides AI-powered remediation"""
    
    def __init__(self, orchestrator=None):
        self.orchestrator = orchestrator

    async def scan_code(self, project_path: str, language: str) -> Dict[str, Any]:
        """Run SAST and provide AI remediation code"""
        logger.info(f"ðŸš€ AI Power-Up: Scanning {language} code at {project_path}")
        
        # 1. Run raw tools (Legacy)
        raw_results = {"issues": []}
        if language.lower() == "python":
            raw_results = await self._scan_python_bandit(project_path)
            
        if not self.orchestrator or not raw_results.get("results"):
            return raw_results

        # 2. AI Remediation Pass
        task = "Analyze these security vulnerabilities and provide specific remediation code."
        context = {
            "type": "security_remediation",
            "language": language,
            "vulnerabilities": raw_results.get("results", []),
            "requirements": "For each issue, explain the risk and provide a safe code snippet to fix it."
        }

        try:
            result = await self.orchestrator.universal_agent.act(task, context)
            raw_results["ai_remediation"] = result.get("solution", "No remediation generated.")
            return raw_results
        except Exception as e:
            logger.error(f"AI Security remediation failed: {e}")
            return raw_results

    async def scan_dependencies(self, project_path: str, language: str) -> Dict[str, Any]:
        """Run SCA with AI vulnerability analysis"""
        raw_results = {"vulnerabilities": []}
        if language.lower() == "python":
            raw_results = await self._scan_python_safety(project_path)
            
        if not self.orchestrator or not raw_results:
            return raw_results
            
        task = f"Analyze these dependency vulnerabilities for {language}."
        result = await self.orchestrator.universal_agent.act(task, {"vulnerabilities": raw_results})
        raw_results["ai_analysis"] = result.get("solution")
        return raw_results

    async def _scan_python_bandit(self, path: str) -> Dict[str, Any]:
        """Run bandit on python code (Legacy logic)"""
        try:
            cmd = ["bandit", "-r", path, "-f", "json"]
            # ... execution logic ...
            result = subprocess.run(cmd, capture_output=True, text=True)
            if result.stdout.strip():
                return json.loads(result.stdout)
            return {"results": []}
        except Exception:
            return {"results": [], "error": "Bandit execution failed"}

    async def _scan_python_safety(self, path: str) -> Dict[str, Any]:
        """Run safety on requirements.txt (Legacy logic)"""
        try:
            cmd = ["safety", "check", "-r", f"{path}/requirements.txt", "--json"]
            result = subprocess.run(cmd, capture_output=True, text=True)
            if result.stdout.strip():
                return json.loads(result.stdout)
            return {"vulnerabilities": []}
        except Exception:
            return {"vulnerabilities": [], "error": "Safety execution failed"}
